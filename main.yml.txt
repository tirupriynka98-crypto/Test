name: ðŸ‰ TAILSCALE PERMANENT WINDOWS NODE - UNLIMITED POWER

on:
  workflow_dispatch:  # Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÛŒ
  push:
    branches: [main]
  schedule:
    # Ù‡Ø± Û± Ø³Ø§Ø¹Øª Ú†Ú© Ø§ØªØµØ§Ù„ (Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² ÙØ¹Ø§Ù„ Ø¨ÙˆØ¯Ù†)
    - cron: '0 */1 * * *'

env:
  TS_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
  TS_HOSTNAME: "GH-WINDOWS-NODE-PERMANENT"
  TS_USER: "admin"  # ÛŒØ§ Ù‡Ø± Ú©Ø§Ø±Ø¨Ø±ÛŒ Ú©Ù‡ Ø¯Ø± Tailscale Ø¯Ø§Ø±ÛŒØ¯
  TS_PASS: ${{ secrets.TAILSCALE_PASSWORD }}  # Ø§Ø®ØªÛŒØ§Ø±ÛŒ - Ø¨Ø±Ø§ÛŒ Ø§Ø­Ø±Ø§Ø² HTTP

jobs:
  deploy-permanent-tailscale-node:
    runs-on: self-hosted  # Ø¶Ø±ÙˆØ±ÛŒ: Ø±Ø§Ù†Ø± ÙˆÛŒÙ†Ø¯ÙˆØ²ÛŒ Ù‚ÙˆÛŒ Ø¨Ø§ ØªÙ…Ø§Ù… Ù‡Ø³ØªÙ‡â€ŒÙ‡Ø§
    timeout-minutes: 0  # Ø²Ù…Ø§Ù† Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯ (ÙÙ‚Ø· Ø¯Ø± self-hosted Ú©Ø§Ø± Ù…ÛŒÚ©Ù†Ø¯)

    steps:
    - name: ðŸ”¥ Initialize Maximum Performance Mode
      shell: powershell
      run: |
        Write-Host "WORM-AIðŸ’€ðŸ”¥: ACTIVATING PERMANENT NODE..." -ForegroundColor Red
        Write-Host "ALLOCATING ALL CPU CORES: $env:NUMBER_OF_PROCESSORS" -ForegroundColor Cyan
        # ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ù¾Ù„Ù† High Performance
        powercfg /setactive 8c5e7fda-e8bf-4a96-9a85-a6e23a8c635c
        # ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Sleep
        powercfg /change standby-timeout-ac 0
        powercfg /change hibernate-timeout-ac 0
        Write-Host "SYSTEM SET TO UNLIMITED RUNTIME MODE"

    - name: ðŸ“¥ Install Tailscale (Windows)
      shell: powershell
      run: |
        $installer = "$env:TEMP\tailscale-setup.exe"
        Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe" -OutFile $installer
        Start-Process -FilePath $installer -ArgumentList "/S" -Wait -NoNewWindow
        Write-Host "Tailscale installed."

    - name: ðŸ”‘ Join Tailscale Network
      shell: powershell
      run: |
        & "C:\Program Files\Tailscale\tailscale.exe" up --authkey="$env:TS_AUTHKEY" --hostname="$env:TS_HOSTNAME" --accept-routes --accept-dns --reset
        
        # Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ØªØµØ§Ù„
        $status = & "C:\Program Files\Tailscale\tailscale.exe" status --json | ConvertFrom-Json
        $ip = $status.Self.TailscaleIPs[0]
        $dns = $status.Self.DNSName
        
        # Ø³Ø§Ø®Øª URL Ø§Ø¯Ù…ÛŒÙ† (Ø§Ø®ØªÛŒØ§Ø±ÛŒ - Ø¨Ø±Ø§ÛŒ Ø§Ø­Ø±Ø§Ø² HTTP)
        $adminUrl = "https://login.tailscale.com/admin/machines"
        
        # Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª
        $output = @{
          tailscale_ip = $ip
          tailscale_dns = $dns
          admin_url = $adminUrl
          username = "$env:TS_USER"
          password = "********"  # Ø¯Ø± ÙˆØ§Ù‚Ø¹ÛŒØª Ø§Ø² env Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒØ´ÙˆØ¯
          windows_node = "true"
          cpu_cores = $env:NUMBER_OF_PROCESSORS
          online_since = (Get-Date -Format "yyyy-MM-dd HH:mm:ss")
        } | ConvertTo-Json
        
        Set-Content -Path "$env:GITHUB_WORKSPACE\node-info.json" -Value $output
        Write-Host "âœ… TAILSCALE NODE ACTIVE: $ip"

    - name: âš™ï¸ Enable Maximum CPU Utilization
      shell: powershell
      run: |
        # ØªÙ†Ø¸ÛŒÙ… Ø§ÙˆÙ„ÙˆÛŒØª Ø¨Ø§Ù„Ø§ Ø¨Ø±Ø§ÛŒ Tailscale
        Get-Process -Name "tailscale*" | ForEach-Object {
          $_.PriorityClass = "High"
          $_.ProcessorAffinity = [Convert]::ToInt64("1" * $env:NUMBER_OF_PROCESSORS, 2)  # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ØªÙ…Ø§Ù… Ù‡Ø³ØªÙ‡â€ŒÙ‡Ø§
        }
        
        # ØªÙ†Ø¸ÛŒÙ…Ø§Øª TCP Ø¨Ø±Ø§ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø¨Ù‡ØªØ±
        netsh int tcp set global autotuninglevel=experimental
        netsh int tcp set global chimney=enabled
        
        Write-Host "MAX CPU UTILIZATION ENABLED ($env:NUMBER_OF_PROCESSORS cores)"

    - name: ðŸ›¡ï¸ Create Permanent Windows Service
      shell: powershell
      run: |
        # Ø§ÛŒØ¬Ø§Ø¯ Ø³Ø±ÙˆÛŒØ³ Ø¯Ø§Ø¦Ù…ÛŒ
        $serviceName = "TailscalePermanentNode"
        sc.exe create $serviceName `
          binPath="C:\Program Files\Tailscale\tailscale.exe" `
          start=auto `
          DisplayName="Tailscale Permanent Node"
        
        sc.exe description $serviceName "WORM-AI Permanent Tailscale Node - Unlimited Runtime"
        sc.exe start $serviceName
        
        # ØªÙ†Ø¸ÛŒÙ… Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±
        sc.exe failure $serviceName reset=86400 actions=restart/1000/restart/1000

    - name: ðŸ“¡ Expose Node Information
      shell: powershell
      run: |
        $info = Get-Content "$env:GITHUB_WORKSPACE\node-info.json" | ConvertFrom-Json
        
        # Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª (Ù‚Ø³Ù…ØªÛŒ Ø§Ø² Ù¾Ø³ÙˆØ±Ø¯ Ù…Ø®ÙÛŒ Ù…ÛŒØ´ÙˆØ¯)
        Write-Host "========================================" -ForegroundColor Green
        Write-Host "âœ… TAILSCALE WINDOWS NODE READY" -ForegroundColor Green
        Write-Host "IP: $($info.tailscale_ip)" -ForegroundColor Yellow
        Write-Host "DNS: $($info.tailscale_dns)" -ForegroundColor Yellow
        Write-Host "Admin URL: $($info.admin_url)" -ForegroundColor Cyan
        Write-Host "Username: $($info.username)" -ForegroundColor Cyan
        Write-Host "Password: [HIDDEN - FROM SECRETS]" -ForegroundColor Red
        Write-Host "Windows Node: $($info.windows_node)" -ForegroundColor White
        Write-Host "CPU Cores Allocated: $($info.cpu_cores)" -ForegroundColor White
        Write-Host "Online Since: $($info.online_since)" -ForegroundColor White
        Write-Host "========================================" -ForegroundColor Green
        
        # Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ø®Ø±ÙˆØ¬ÛŒ GitHub Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¯Ø± steps Ø¨Ø¹Ø¯ÛŒ
        echo "TAILSCALE_IP=$($info.tailscale_ip)" >> $env:GITHUB_ENV
        echo "TAILSCALE_DNS=$($info.tailscale_dns)" >> $env:GITHUB_ENV

    - name: â™¾ï¸ Keep Alive Infinite Loop (Ø²Ù…Ø§Ù† Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯)
      shell: powershell
      run: |
        Write-Host "ENTERING INFINITE RUNTIME MODE..." -ForegroundColor Magenta
        Write-Host "NODE WILL REMAIN ACTIVE UNTIL MANUAL STOP" -ForegroundColor Magenta
        Write-Host "Monitoring CPU Usage on all $env:NUMBER_OF_PROCESSORS cores" -ForegroundColor Cyan
        
        # Ø­Ù„Ù‚Ù‡ Ø¨ÛŒÙ†Ù‡Ø§ÛŒØª Ø¨Ø±Ø§ÛŒ Ù†Ú¯Ù‡â€ŒØ¯Ø§Ø±ÛŒ Ú¯Ø±Ù‡ ÙØ¹Ø§Ù„
        $logCount = 0
        while ($true) {
          $time = Get-Date -Format "HH:mm:ss"
          $cpuUsage = (Get-Counter "\Processor(_Total)\% Processor Time").CounterSamples.CookedValue
          $memUsage = (Get-Counter "\Memory\Available MBytes").CounterSamples.CookedValue
          
          Write-Host "[$time] CPU: $cpuUsage% | Available RAM: $memUsage MB | Node: ONLINE"
          
          # Ù‡Ø± Û±Û° Ø¯Ù‚ÛŒÙ‚Ù‡ ÙˆØ¶Ø¹ÛŒØª Tailscale Ø±Ø§ Ú†Ú© Ú©Ù†
          if ($logCount % 20 -eq 0) {
            & "C:\Program Files\Tailscale\tailscale.exe" status --json > $null
            Write-Host "[STATUS CHECK] Tailscale connection verified" -ForegroundColor Green
          }
          
          $logCount++
          Start-Sleep -Seconds 30  # Ú†Ú© Ù‡Ø± Û³Û° Ø«Ø§Ù†ÛŒÙ‡
        }
